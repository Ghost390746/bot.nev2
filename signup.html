<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Signup ‚Äî Botnev</title>
<style>
body { font-family: Arial, sans-serif; background:#f9fafc; margin:0; padding:20px; text-align:center; }
h1 { color:#333; }
input, a { width:100%; max-width:400px; margin:10px 0; padding:10px; font-size:16px; border-radius:5px; border:1px solid #ccc; display:block; text-decoration:none; text-align:center; }
a { background:#007bff; color:white; cursor:pointer; }
a:hover { background:#0056b3; }
#output { margin-top:20px; font-family:monospace; padding:10px; border-radius:6px; }
.disabled { background:#ccc !important; cursor:not-allowed !important; }
</style>
</head>
<body>

<h1>Signup for Botnev</h1>

<input type="email" id="email" placeholder="Email" required />
<input type="password" id="password" placeholder="Password (min 30 chars, uppercase first, number last, 2+ symbols)" required />
<div class="h-captcha" data-sitekey="2b1cc900-c846-40e8-bf32-dbeeeec2d1c0"></div>
<a href="#" id="signupBtn">üéûÔ∏è Signup</a>

<div id="output"></div>

<script>
const output = document.getElementById('output');
const signupBtn = document.getElementById('signupBtn');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');

async function checkLimit() {
  try {
    const res = await fetch('/.netlify/functions/check-limit');
    const data = await res.json();
    if(!data.allowed){
      output.textContent = "Signup limit reached. Only the test account is allowed.";
      signupBtn.classList.add('disabled');
      signupBtn.removeEventListener('click', signupHandler);
      return false;
    }
    return true;
  } catch(err) {
    console.error(err);
    output.textContent = "Failed to check user limit.";
    return false;
  }
}

async function signupHandler(e) {
  e.preventDefault();

  const email = emailInput.value.trim();
  const password = passwordInput.value.trim();
  const username = email.split('@')[0];
  const captcha_token = hcaptcha.getResponse();

  if(!email || !password) {
    output.textContent = "Enter email and password.";
    return;
  }

  if(!captcha_token) {
    output.textContent = "Complete the CAPTCHA.";
    return;
  }

  try {
    const res = await fetch('/.netlify/functions/signup', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ email, username, password, captcha_token })
    });

    const data = await res.json();
    if(!data.success) { 
      output.textContent = `Error: ${data.error}`;
      return; 
    }

    output.innerHTML = `
      Verification code sent! Check your email.<br>
      <input id="codeInput" placeholder="Enter verification code" />
      <a href="#" id="verifyBtn">Verify</a>
    `;

    document.getElementById('verifyBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      const code = document.getElementById('codeInput').value.trim();
      if(!code) { output.textContent = "Enter the verification code."; return; }

      const verifyRes = await fetch('/.netlify/functions/verify', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ email, code })
      });

      const verifyData = await verifyRes.json();
      if(verifyData.success){
        output.textContent = "Email verified! Redirecting...";
        setTimeout(()=>window.location.href='/index.html',1500);
      } else {
        output.textContent = `Verification failed: ${verifyData.error}`;
      }
    });

  } catch(err) {
    output.textContent = `Error: ${err.message}`;
  }
}

// Check limit before enabling signup
checkLimit().then(allowed => {
  if(allowed){
    signupBtn.addEventListener('click', signupHandler);
  }
});
</script>
<script src="https://js.hcaptcha.com/1/api.js" async defer></script>
</body>
</html>
