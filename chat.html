<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; display: flex; height: 100vh; }
#sidebar { width: 260px; background: #f4f4f4; padding: 10px; overflow-y: auto; border-right: 1px solid #ccc; }
.chat-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #ddd; border-radius: 5px; }
.chat-item:hover { background: #ddd; }
#chatArea { flex: 1; display: flex; flex-direction: column; }
#chatHeader { padding: 10px; border-bottom: 1px solid #ccc; background: #fafafa; font-weight: bold; }
#messages { flex: 1; padding: 10px; overflow-y: auto; }
.message { margin-bottom: 10px; padding: 8px; border-radius: 6px; max-width: 70%; background: #e9e9e9; }
.message.you { background: #d0ebff; margin-left: auto; }
.meta { font-size: 11px; color: #555; }
.reactions { margin-top: 4px; font-size: 16px; cursor: pointer; }
#inputBar { display: flex; padding: 10px; border-top: 1px solid #ccc; }
#inputBar input { flex: 1; padding: 8px; }
#inputBar button { margin-left: 5px; }
</style>
</head>

<body>
<div id="sidebar">
  <h3>Chats</h3>
  <div id="chatList">Loading‚Ä¶</div>
  <button onclick="newChat()">‚ûï New Chat</button>
  <hr>
  <button onclick="openReactions()">üëç Reactions</button>
  <button onclick="openFiles()">üìÅ Files</button>
  <button onclick="openBots()">ü§ñ Bots</button>
  <button onclick="toggleMute()">üîï Mute/Archive</button>
  <button onclick="kickUser()">üö´ Kick User</button>
  <button onclick="renameChat()">‚úèÔ∏è Rename Chat</button>
</div>

<div id="chatArea">
  <div id="chatHeader">Select a chat</div>
  <div id="messages"></div>
  <div id="inputBar">
    <input id="msgInput" placeholder="Type a message‚Ä¶" />
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
let conversationId = null;
let myUserId = null;
let myEmail = null;

// Get session token from cookie
function getToken() {
  return document.cookie.split('; ').find(r => r.startsWith('session_token='))?.split('=')[1];
}

// -----------------------
// INIT USER
// -----------------------
async function initUser() {
  try {
    const res = await fetch('/.netlify/functions/profileCreation', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ session_token: getToken() })
    });
    const data = await res.json();
    if (data.success) {
      myUserId = data.user.id;
      myEmail = data.user.email;
    } else {
      console.error("Profile error:", data.error);
    }
  } catch (err) {
    console.error("Failed to load user:", err);
  }
}

// -----------------------
// LOAD CHAT LIST
// -----------------------
async function loadChats() {
  try {
    const res = await fetch('/.netlify/functions/chat-list', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ session_token: getToken() })
    });
    const data = await res.json();
    const list = document.getElementById('chatList');
    list.innerHTML = '';

    if (!data.success || !data.chats || data.chats.length === 0) {
      list.textContent = "No chats yet.";
      return;
    }

    data.chats.forEach(c => {
      const div = document.createElement('div');
      div.className = 'chat-item';
      div.textContent = c.title || `Chat with ${c.user_emails.filter(e=>e!==myEmail).join(', ')}`;
      div.onclick = () => openChat(c.id, div.textContent);
      list.appendChild(div);
    });

  } catch (err) {
    console.error("Failed to load chats:", err);
    document.getElementById('chatList').textContent = "Failed to load chats.";
  }
}

// -----------------------
// OPEN CHAT
// -----------------------
async function openChat(id, title) {
  conversationId = id;
  document.getElementById('chatHeader').textContent = title;
  document.getElementById('messages').innerHTML = '';
  await loadMessages();
}

// -----------------------
// LOAD MESSAGES
// -----------------------
async function loadMessages() {
  if (!conversationId) return;
  try {
    const res = await fetch('/.netlify/functions/chat-messages', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ session_token: getToken(), conversation_id: conversationId })
    });
    const data = await res.json();
    const msgsContainer = document.getElementById('messages');
    msgsContainer.innerHTML = '';
    if (data.success && data.messages) {
      data.messages.forEach(renderMessage);
    } else {
      msgsContainer.textContent = "No messages yet.";
    }
  } catch (err) {
    console.error("Failed to load messages:", err);
    document.getElementById('messages').textContent = "Failed to load messages.";
  }
}

// -----------------------
// SEND MESSAGE
// -----------------------
async function sendMessage() {
  const input = document.getElementById('msgInput');
  if (!input.value || !conversationId) return;
  try {
    const res = await fetch('/.netlify/functions/chat-send', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ session_token: getToken(), conversation_id: conversationId, content: input.value })
    });
    const data = await res.json();
    if (data.success) {
      input.value = '';
      await loadMessages();
    } else {
      alert("Failed to send message: " + data.error);
    }
  } catch (err) {
    console.error("Failed to send message:", err);
  }
}

// -----------------------
// RENDER MESSAGE
// -----------------------
function renderMessage(msg) {
  const div = document.createElement('div');
  div.className = 'message' + (msg.sender_id === myUserId ? ' you' : '');
  div.id = `msg-${msg.id}`;
  const time = new Date(msg.created_at).toLocaleTimeString();
  div.innerHTML = `
    <div><strong>${msg.sender_username}</strong> (${msg.sender_email}): ${msg.content}</div>
    <div class="meta">${time}</div>
  `;
  document.getElementById('messages').appendChild(div);
  document.getElementById('messages').scrollTop = 999999;
}

// -----------------------
// NEW CHAT
// -----------------------
async function newChat() {
  const otherUser = prompt("Enter the email of the person to chat with:");
  if (!otherUser) return;

  try {
    const res = await fetch('/.netlify/functions/chat-create', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ session_token: getToken(), user_emails: [myEmail, otherUser] })
    });
    const data = await res.json();
    if (data.success && data.id) {
      loadChats();
      openChat(data.id, data.title || `Chat with ${otherUser}`);
    } else {
      alert("Failed to create chat: " + (data.error || JSON.stringify(data)));
    }
  } catch (err) {
    console.error("Failed to create chat:", err);
  }
}

// -----------------------
// INIT
// -----------------------
initUser().then(loadChats);

</script>
</body>
</html>
