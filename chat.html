<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  display: flex;
  height: 100vh;
}

#sidebar {
  width: 250px;
  background: #f4f4f4;
  padding: 10px;
  overflow-y: auto;
}

#chatArea {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.chat-item {
  padding: 10px;
  cursor: pointer;
  border-bottom: 1px solid #ddd;
}

.chat-item:hover {
  background: #ddd;
}

#messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
}

#inputBar {
  display: flex;
  padding: 10px;
  border-top: 1px solid #ccc;
}

#inputBar input {
  flex: 1;
  padding: 8px;
}

#inputBar button {
  margin-left: 5px;
}
</style>
</head>

<body>

<div id="sidebar">
  <h3>Chats</h3>
  <div id="chatList">Loadingâ€¦</div>

  <hr>
  <button onclick="alert('Message reactions coming soon ğŸ‘')">ğŸ‘ Reactions</button>
  <button onclick="alert('File sharing coming soon ğŸ“')">ğŸ“ Files</button>
  <button onclick="alert('Bots in chat coming soon ğŸ¤–')">ğŸ¤– Bots</button>
  <button onclick="alert('Mute & archive coming soon ğŸ”•')">ğŸ”• Mute</button>
</div>

<div id="chatArea">
  <div id="messages"></div>

  <div id="inputBar">
    <input id="msgInput" placeholder="Type a messageâ€¦" />
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
/* -----------------------
   SUPABASE SETUP
----------------------- */
const supabase = supabaseJs.createClient(
  'YOUR_SUPABASE_URL',
  'YOUR_PUBLIC_ANON_KEY'
);

let conversationId = null;
let channel = null;

/* -----------------------
   LOAD CHAT LIST
----------------------- */
async function loadChats() {
  const res = await fetch('/.netlify/functions/chat-list?session_token=' + getToken());
  const chats = await res.json();

  const list = document.getElementById('chatList');
  list.innerHTML = '';

  chats.forEach(c => {
    const div = document.createElement('div');
    div.className = 'chat-item';
    div.textContent = c.conversations.title || 'Private Chat';
    div.onclick = () => openChat(c.conversation_id);
    list.appendChild(div);
  });
}

/* -----------------------
   OPEN CHAT
----------------------- */
async function openChat(id) {
  conversationId = id;
  document.getElementById('messages').innerHTML = '';
  await loadMessages();
  startRealtime();
}

/* -----------------------
   LOAD MESSAGES
----------------------- */
async function loadMessages() {
  const res = await fetch(`/.netlify/functions/chat-messages?id=${conversationId}`);
  const msgs = await res.json();
  msgs.forEach(renderMessage);
}

/* -----------------------
   REALTIME (THIS ANSWERS YOUR QUESTION)
----------------------- */
function startRealtime() {
  if (channel) supabase.removeChannel(channel);

  channel = supabase
    .channel('chat-' + conversationId)
    .on(
      'postgres_changes',
      { event: 'INSERT', schema: 'public', table: 'messages' },
      payload => {
        renderMessage(payload.new);
      }
    )
    .subscribe();
}

/* -----------------------
   SEND MESSAGE
----------------------- */
async function sendMessage() {
  const input = document.getElementById('msgInput');
  if (!input.value) return;

  await fetch('/.netlify/functions/chat-send', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      session_token: getToken(),
      conversation_id: conversationId,
      content: input.value
    })
  });

  input.value = '';
}

/* -----------------------
   RENDER MESSAGE
----------------------- */
function renderMessage(msg) {
  const div = document.createElement('div');
  div.textContent = msg.content;
  document.getElementById('messages').appendChild(div);
}

/* -----------------------
   TOKEN HELPER
----------------------- */
function getToken() {
  return document.cookie
    .split('; ')
    .find(r => r.startsWith('session_token='))
    ?.split('=')[1];
}

loadChats();
</script>

</body>
</html>
