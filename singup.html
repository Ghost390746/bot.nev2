<script>
const output = document.getElementById('output');

document.getElementById('signupBtn').addEventListener('click', async (e) => {
  e.preventDefault(); // prevent redirect

  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();
  const username = email.split('@')[0]; // optional: generate username

  if (!email || !password) {
    output.textContent = "Enter email and password.";
    return;
  }

  try {
    const res = await fetch('/.netlify/functions/signup', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ email, username, password })
    });

    const data = await res.json();

    if (data.success) {
      output.innerHTML = `
        Verification code sent! Check your email.<br>
        <input id="codeInput" placeholder="Enter verification code" />
        <button id="verifyBtn">Verify</button>
      `;

      document.getElementById('verifyBtn').addEventListener('click', async () => {
        const code = document.getElementById('codeInput').value.trim();
        const verifyRes = await fetch('/.netlify/functions/verify', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ email, code })
        });
        const verifyData = await verifyRes.json();

        if (verifyData.success) {
          output.textContent = "Email verified! Redirecting...";
          setTimeout(() => window.location.href = '/index.html', 1500);
        } else {
          output.textContent = `Verification failed: ${verifyData.error}`;
        }
      });

    } else {
      output.textContent = `Error: ${data.error}`;
    }

  } catch (err) {
    output.textContent = `Error: ${err.message}`;
  }
});
</script>
