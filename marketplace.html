<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bot Marketplace</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9fafc; margin: 0; padding: 40px; }
    h1 { text-align: center; color: #333; }
    .bot-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 30px; }
    .bot-card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; }
    .bot-card img { width: 100%; border-radius: 5px; margin-bottom: 10px; }
    .bot-card h2 { margin: 0 0 10px 0; }
    .bot-card p { font-size: 14px; color: #555; }
    .bot-card a { margin-top: 10px; text-decoration: none; color: white; background: #007bff; padding: 8px; border-radius: 5px; text-align: center; display: inline-block; }
    .bot-card a:hover { background: #0056b3; }
    form { margin-top: 40px; max-width: 500px; margin-left: auto; margin-right: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    input, textarea { width: 100%; margin-bottom: 10px; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
    button { background: #28a745; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; }
    button:hover { background: #218838; }
    .output { margin-top: 10px; font-family: monospace; padding: 10px; border-radius: 5px; }
    .output.success { background: #e6ffed; color: #256d1b; border: 1px solid #8dd48a; }
    .output.error { background: #ffe6e6; color: #a12626; border: 1px solid #f5a3a3; }
  </style>
</head>
<body>

<h1>ðŸ¤– Bot Marketplace</h1>
<div class="bot-grid" id="botGrid">Loading bots...</div>

<h2 style="text-align:center;">Add a New Bot</h2>
<form id="createBotForm" enctype="multipart/form-data">
  <input type="text" id="name" placeholder="Bot Name" required>
  <textarea id="description" placeholder="Bot Description" required></textarea>
  <input type="file" id="profile_picture_file" accept="image/*">
  <input type="file" id="fbx_file" accept=".fbx" required>
  <input type="text" id="paid_link" placeholder="Optional Gumroad Link">
  <input type="number" id="price_points" placeholder="Price in Points">
  <input type="email" id="seller_email" placeholder="Your Email" required>
  <button type="submit">Create Bot</button>
  <div id="output" class="output"></div>
</form>

<script>
const botGrid = document.getElementById('botGrid');
const form = document.getElementById('createBotForm');
const output = document.getElementById('output');

const getBotsPath = window.location.hostname.includes('localhost')
  ? '/netlify/functions/getMarketplaceBots'
  : '/.netlify/functions/getMarketplaceBots';

const createBotPath = window.location.hostname.includes('localhost')
  ? '/netlify/functions/createMarketplaceBot'
  : '/.netlify/functions/createMarketplaceBot';

// Load bots and display price + seller info
async function loadBots() {
  try {
    const res = await fetch(getBotsPath);
    const bots = await res.json();
    if (!Array.isArray(bots) || bots.length === 0) {
      botGrid.innerHTML = '<p>No bots found.</p>';
      return;
    }
    botGrid.innerHTML = '';
    bots.forEach(bot => {
      const card = document.createElement('div');
      card.className = 'bot-card';
      card.innerHTML = `
        <img src="${bot.profile_picture || 'https://via.placeholder.com/250'}" alt="${bot.name}">
        <h2>${bot.name}</h2>
        <p>${bot.description}</p>
        <p><strong>Price:</strong> ${bot.price_points || 0} points</p>
        <p><strong>Seller:</strong> ${bot.seller_email}</p>
        <a href="${bot.paid_link || '#'}" target="_blank">${bot.paid_link ? 'Buy' : 'View'}</a>
      `;
      botGrid.appendChild(card);
    });
  } catch(err) {
    console.error(err);
    botGrid.innerHTML = '<p>Failed to load bots.</p>';
  }
}

// Handle bot creation
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  output.textContent = 'Creating bot...';
  output.className = 'output';

  const name = document.getElementById('name').value.trim();
  const description = document.getElementById('description').value.trim();
  const seller_email = document.getElementById('seller_email').value.trim();
  const price_points = parseInt(document.getElementById('price_points').value) || 0;
  const paid_link = document.getElementById('paid_link').value.trim();

  const profile_picture_file = document.getElementById('profile_picture_file').files[0];
  const fbx_file = document.getElementById('fbx_file').files[0];

  if (!name || !description || !seller_email || !fbx_file) {
    output.textContent = 'Please fill all required fields and upload the FBX.';
    output.className = 'output error';
    return;
  }

  const formData = new FormData();
  formData.append('name', name);
  formData.append('description', description);
  formData.append('seller_email', seller_email);
  formData.append('price_points', price_points);
  formData.append('paid_link', paid_link);
  if (profile_picture_file) formData.append('profile_picture_file', profile_picture_file);
  formData.append('fbx_file', fbx_file);

  try {
    const res = await fetch(createBotPath, { method: 'POST', body: formData });
    const data = await res.json();
    if (!res.ok || data.error) {
      output.textContent = data.error || 'Failed to create bot';
      output.className = 'output error';
      return;
    }
    output.textContent = 'Bot created successfully!';
    output.className = 'output success';
    form.reset();
    loadBots(); // Refresh marketplace
  } catch(err) {
    console.error(err);
    output.textContent = 'Failed to create bot';
    output.className = 'output error';
  }
});

loadBots();
</script>
</body>
</html>
