<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Botnet2 Site Builder</title>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: white;
      padding: 20px;
    }
    input, button {
      padding: 10px;
      margin: 10px 0;
      width: 100%;
    }
    iframe {
      width: 100%;
      height: 400px;
      border: 1px solid #333;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<h1>Botnet2 Site Builder</h1>
<p>Your site will live at: <strong>https://&lt;site-name&gt;.botnet2.netlify.app</strong></p>

<input type="text" id="siteName" placeholder="Enter site name (letters, numbers, -)" />
<input type="file" id="zipFile" accept=".zip" />
<button id="createSiteBtn">Create Site</button>

<iframe id="previewFrame"></iframe>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js'

  // Initialize Supabase
  const supabase = createClient(
    'YOUR_SUPABASE_URL',
    'YOUR_SUPABASE_KEY'
  );

  const zipInput = document.getElementById('zipFile');
  const siteNameInput = document.getElementById('siteName');
  const createBtn = document.getElementById('createSiteBtn');
  const previewFrame = document.getElementById('previewFrame');

  createBtn.addEventListener('click', async () => {
    const siteName = siteNameInput.value.trim();
    const file = zipInput.files[0];
    if (!siteName || !file) {
      alert('Please provide site name and ZIP file.');
      return;
    }

    if (!/^[a-z0-9-]{3,30}$/.test(siteName)) {
      alert('Site name invalid. Only lowercase letters, numbers, and - allowed.');
      return;
    }

    try {
      const zip = await JSZip.loadAsync(file);

      // Upload files to Supabase Storage
      for (const [filename, zipEntry] of Object.entries(zip.files)) {
        if (zipEntry.dir) continue;

        // Only allow static web files
        if (!/\.(html|css|js|png|jpg|jpeg|svg|json)$/.test(filename)) continue;

        const content = await zipEntry.async('arraybuffer');
        await supabase.storage
          .from('sites')
          .upload(`${siteName}/${filename}`, content, { upsert: true });
      }

      // Call create-site function to register site and expiration
      const response = await fetch('/.netlify/functions/create-site', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-user-id': 'demo-user-id',   // Replace with real user ID in your system
          'x-site-name': siteName
        },
        body: JSON.stringify({ user_id: 'demo-user-id', site_name: siteName })
      });

      const data = await response.json();
      if (!data.success) {
        alert(data.error || 'Failed to create site');
        return;
      }

      alert(`Site created! Visit: ${data.url}`);
      previewFrame.src = `https://${siteName}.botnet2.netlify.app`;

    } catch (err) {
      console.error(err);
      alert('Error uploading files or creating site.');
    }
  });
</script>

</body>
</html>
