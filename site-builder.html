<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fire-USA Site Builder</title>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #111; color: white; padding: 20px; }
    input, button, select { padding: 10px; margin: 10px 0; width: 100%; }
    iframe { width: 100%; height: 400px; border: 1px solid #333; margin-top: 20px; }
  </style>
</head>
<body>

<h1>Fire-USA Site Builder</h1>
<p>Your site will live at: <strong>https://&lt;site-name&gt;.fire-usa.com</strong></p>

<input type="text" id="siteName" placeholder="Enter site name (letters, numbers, -)" />
<input type="file" id="zipFile" accept=".zip" />
<button id="githubLoginBtn">Login with GitHub</button>
<select id="repoSelect" style="display:none;">
  <option value="">Select a repo</option>
</select>
<button id="createSiteBtn" style="display:none;">Create Site</button>

<iframe id="previewFrame"></iframe>

<script type="module">
  const zipInput = document.getElementById('zipFile');
  const siteNameInput = document.getElementById('siteName');
  const githubLoginBtn = document.getElementById('githubLoginBtn');
  const repoSelect = document.getElementById('repoSelect');
  const createBtn = document.getElementById('createSiteBtn');
  const previewFrame = document.getElementById('previewFrame');

  // GitHub OAuth login starts via backend (create-site handles secrets)
  githubLoginBtn.addEventListener('click', () => {
    window.location.href = '/.netlify/functions/create-site?action=login';
  });

  // Extract GitHub OAuth code from URL after redirect
  const urlParams = new URLSearchParams(window.location.search);
  const githubCode = urlParams.get('code');

  if (githubCode) {
    githubLoginBtn.style.display = 'none';
    repoSelect.style.display = 'block';
    createBtn.style.display = 'block';

    // Fetch user's repos via backend function (token exchange handled safely)
    fetch('/.netlify/functions/create-site', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'get-repos', github_code: githubCode })
    })
      .then(res => res.json())
      .then(data => {
        const repos = data.repos || [];
        repos.forEach(repo => {
          const option = document.createElement('option');
          option.value = JSON.stringify({ owner: repo.owner.login, name: repo.name });
          option.textContent = repo.full_name;
          repoSelect.appendChild(option);
        });

        // Clean URL so ?code=â€¦ is gone
        window.history.replaceState({}, '', window.location.pathname);
      })
      .catch(err => {
        console.error('Failed to fetch repos:', err);
        alert('Failed to fetch GitHub repositories');
      });
  }

  createBtn.addEventListener('click', async () => {
    const siteName = siteNameInput.value.trim();
    const file = zipInput.files[0];
    const selectedRepo = repoSelect.value ? JSON.parse(repoSelect.value) : null;

    if (!siteName || !file || !selectedRepo) {
      alert('Please provide site name, ZIP file, and select a repo.');
      return;
    }

    if (!/^[a-z0-9-]{3,30}$/.test(siteName)) {
      alert('Site name invalid. Only lowercase letters, numbers, and - allowed.');
      return;
    }

    try {
      const jszip = new JSZip();
      const zipData = await jszip.loadAsync(file);
      const files = {};
      for (const filename of Object.keys(zipData.files)) {
        if (!zipData.files[filename].dir) {
          files[filename] = await zipData.files[filename].async('text');
        }
      }

      // Call create-site function to push files and handle OAuth securely
      const response = await fetch('/.netlify/functions/create-site', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          site_name: siteName,
          files,
          github_code: githubCode,
          github_repo_owner: selectedRepo.owner,
          github_repo_name: selectedRepo.name
        })
      });

      const data = await response.json();
      if (!data.success) {
        alert(data.error || 'Failed to create site');
        return;
      }

      alert(`Site created! GitHub repo: ${data.githubUrl}`);
      previewFrame.src = `https://${siteName}.fire-usa.com`;

    } catch (err) {
      console.error('Error creating site:', err);
      alert('Error creating site. Check console for details.');
    }
  });
</script>

</body>
</html>
